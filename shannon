#!/bin/bash
# Shannon CLI - AI Penetration Testing Framework

set -e

RUNTIME_DIR="${SHANNON_RUNTIME_DIR:-.shannon}"
TEMPORAL_PID_FILE="$RUNTIME_DIR/temporal.pid"
WORKER_PID_FILE="$RUNTIME_DIR/worker.pid"
TEMPORAL_LOG_FILE="$RUNTIME_DIR/temporal.log"
WORKER_LOG_FILE="$RUNTIME_DIR/worker.log"
TEMPORAL_DB_FILE="$RUNTIME_DIR/temporal.db"

# Load .env if present
if [ -f .env ]; then
  set -a
  source .env
  set +a
fi

show_help() {
  cat << 'EOF'

  ███████╗██╗  ██╗ █████╗ ███╗   ██╗███╗   ██╗ ██████╗ ███╗   ██╗
  ██╔════╝██║  ██║██╔══██╗████╗  ██║████╗  ██║██╔═══██╗████╗  ██║
  ███████╗███████║███████║██╔██╗ ██║██╔██╗ ██║██║   ██║██╔██╗ ██║
  ╚════██║██╔══██║██╔══██║██║╚██╗██║██║╚██╗██║██║   ██║██║╚██╗██║
  ███████║██║  ██║██║  ██║██║ ╚████║██║ ╚████║╚██████╔╝██║ ╚████║
  ╚══════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═══╝╚═╝  ╚═══╝ ╚═════╝ ╚═╝  ╚═══╝

           AI Penetration Testing Framework

Usage:
  ./shannon start URL=<url> REPO=<path>   Start a pentest workflow
  ./shannon logs ID=<workflow-id>         Tail logs for a specific workflow
  ./shannon query ID=<workflow-id>        Query workflow progress
  ./shannon stop                          Stop local Temporal and worker processes
  ./shannon help                          Show this help message

Options for 'start':
  CONFIG=<path>          Configuration file (YAML)
  OUTPUT=<path>          Output directory for reports (default: ./audit-logs/)
  PIPELINE_TESTING=true  Use minimal prompts for fast testing
  REBUILD=true           Force local rebuild of TypeScript artifacts
  ROUTER=true            Route requests through claude-code-router (multi-model support)

Options for 'stop':
  CLEAN=true             Remove all local Temporal data

Examples:
  ./shannon start URL=https://example.com REPO=/path/to/repo
  ./shannon start URL=https://example.com REPO=/path/to/repo CONFIG=./config.yaml
  ./shannon start URL=https://example.com REPO=/path/to/repo OUTPUT=./my-reports
  ./shannon logs ID=example.com_shannon-1234567890
  ./shannon query ID=shannon-1234567890
  ./shannon stop CLEAN=true

Monitor workflows at http://localhost:8233
EOF
}

# Parse KEY=value arguments into variables
parse_args() {
  for arg in "$@"; do
    case "$arg" in
      URL=*) URL="${arg#URL=}" ;;
      REPO=*) REPO="${arg#REPO=}" ;;
      CONFIG=*) CONFIG="${arg#CONFIG=}" ;;
      OUTPUT=*) OUTPUT="${arg#OUTPUT=}" ;;
      ID=*) ID="${arg#ID=}" ;;
      CLEAN=*) CLEAN="${arg#CLEAN=}" ;;
      PIPELINE_TESTING=*) PIPELINE_TESTING="${arg#PIPELINE_TESTING=}" ;;
      REBUILD=*) REBUILD="${arg#REBUILD=}" ;;
      ROUTER=*) ROUTER="${arg#ROUTER=}" ;;
    esac
  done
}

ensure_runtime_dir() {
  mkdir -p "$RUNTIME_DIR"
}

is_pid_running() {
  local pid="$1"
  if [ -z "$pid" ]; then
    return 1
  fi
  kill -0 "$pid" 2>/dev/null
}

pid_from_file() {
  local pid_file="$1"
  if [ -f "$pid_file" ]; then
    cat "$pid_file"
  fi
}

require_temporal_cli() {
  if ! command -v temporal >/dev/null 2>&1; then
    echo "ERROR: Temporal CLI not found."
    echo "Install it from https://docs.temporal.io/cli and try again."
    exit 1
  fi
}

is_temporal_ready() {
  local address="${TEMPORAL_ADDRESS:-localhost:7233}"
  temporal operator cluster health --address "$address" 2>/dev/null | grep -q "SERVING"
}

ensure_dependencies() {
  if [ ! -d node_modules ]; then
    echo "Installing Shannon dependencies..."
    npm install
  fi
  if [ ! -d mcp-server/node_modules ]; then
    echo "Installing MCP server dependencies..."
    npm --prefix mcp-server install
  fi
}

ensure_build() {
  local needs_mcp_build="false"
  local needs_shannon_build="false"

  if [ "$REBUILD" = "true" ] || [ ! -f "mcp-server/dist/index.js" ]; then
    needs_mcp_build="true"
  fi

  if [ "$REBUILD" = "true" ] || [ ! -f "dist/temporal/client.js" ] || [ ! -f "dist/temporal/worker.js" ] || [ ! -f "dist/temporal/query.js" ]; then
    needs_shannon_build="true"
  fi

  if [ "$needs_mcp_build" = "true" ] || [ "$needs_shannon_build" = "true" ]; then
    ensure_dependencies
    if [ "$needs_mcp_build" = "true" ]; then
      npm --prefix mcp-server run build
    fi
    if [ "$needs_shannon_build" = "true" ]; then
      npm run build
    fi
  fi
}

ensure_temporal() {
  local address="${TEMPORAL_ADDRESS:-localhost:7233}"
  local bind_ip="${TEMPORAL_BIND_IP:-127.0.0.1}"

  require_temporal_cli

  if is_temporal_ready; then
    return 0
  fi

  if [ "$address" != "localhost:7233" ] && [ "$address" != "127.0.0.1:7233" ] && [ "$address" != "${bind_ip}:7233" ]; then
    echo "ERROR: Temporal is not reachable at ${address}."
    echo "Start the Temporal server and try again."
    exit 1
  fi

  if [ "$bind_ip" = "0.0.0.0" ]; then
    echo "WARNING: TEMPORAL_BIND_IP is set to 0.0.0.0; this exposes Temporal on all interfaces."
  elif [ "$bind_ip" != "127.0.0.1" ]; then
    echo "WARNING: TEMPORAL_BIND_IP is set to ${bind_ip}. Ensure this is intended."
  fi

  ensure_runtime_dir

  local pid
  pid="$(pid_from_file "$TEMPORAL_PID_FILE")"
  if ! is_pid_running "$pid"; then
    echo "Starting Temporal server..."
    temporal server start-dev --db-filename "$TEMPORAL_DB_FILE" --ip "$bind_ip" > "$TEMPORAL_LOG_FILE" 2>&1 &
    local temporal_pid=$!
    echo "$temporal_pid" > "$TEMPORAL_PID_FILE"
    sleep 1
    if ! is_pid_running "$temporal_pid"; then
      echo "ERROR: Temporal server failed to start. Check ${TEMPORAL_LOG_FILE}."
      rm -f "$TEMPORAL_PID_FILE"
      exit 1
    fi
  fi

  echo "Waiting for Temporal to be ready..."
  for i in $(seq 1 30); do
    if is_temporal_ready; then
      echo "Temporal is ready!"
      return 0
    fi
    if [ "$i" -eq 30 ]; then
      echo "Timeout waiting for Temporal"
      exit 1
    fi
    sleep 2
  done
}

ensure_worker() {
  ensure_runtime_dir

  local pid
  pid="$(pid_from_file "$WORKER_PID_FILE")"
  if is_pid_running "$pid"; then
    return 0
  fi

  echo "Starting Shannon worker..."
  node dist/temporal/worker.js > "$WORKER_LOG_FILE" 2>&1 &
  local worker_pid=$!
  echo "$worker_pid" > "$WORKER_PID_FILE"
  sleep 1
  if ! is_pid_running "$worker_pid"; then
    echo "ERROR: Shannon worker failed to start. Check ${WORKER_LOG_FILE}."
    rm -f "$WORKER_PID_FILE"
    exit 1
  fi
}

stop_process() {
  local pid_file="$1"
  local label="$2"
  local pid

  pid="$(pid_from_file "$pid_file")"
  if is_pid_running "$pid"; then
    echo "Stopping ${label} (PID ${pid})..."
    kill "$pid"
    for _ in $(seq 1 10); do
      if ! is_pid_running "$pid"; then
        break
      fi
      sleep 1
    done
    if is_pid_running "$pid"; then
      echo "Force stopping ${label} (PID ${pid})..."
      kill -9 "$pid"
    fi
  fi

  rm -f "$pid_file"
}

cmd_start() {
  parse_args "$@"

  # Validate required vars
  if [ -z "$URL" ] || [ -z "$REPO" ]; then
    echo "ERROR: URL and REPO are required"
    echo "Usage: ./shannon start URL=<url> REPO=<path>"
    exit 1
  fi

  # Check for API key (router mode can use alternative provider API keys)
  if [ -z "$ANTHROPIC_API_KEY" ] && [ -z "$CLAUDE_CODE_OAUTH_TOKEN" ]; then
    if [ "$ROUTER" = "true" ] && { [ -n "$OPENAI_API_KEY" ] || [ -n "$OPENROUTER_API_KEY" ]; }; then
      # Router mode with alternative provider - set a placeholder for SDK init
      export ANTHROPIC_API_KEY="router-mode"
    else
      echo "ERROR: Set ANTHROPIC_API_KEY or CLAUDE_CODE_OAUTH_TOKEN in .env"
      echo "       (or use ROUTER=true with OPENAI_API_KEY or OPENROUTER_API_KEY)"
      exit 1
    fi
  fi

  if [ -n "$REPO" ] && [ -d "$REPO" ]; then
    REPO="$(cd "$REPO" && pwd)"
  fi

  if [ -n "$OUTPUT" ]; then
    mkdir -p "$OUTPUT"
    if [ -d "$OUTPUT" ]; then
      OUTPUT="$(cd "$OUTPUT" && pwd)"
    fi
  fi

  # Handle ROUTER flag - start claude-code-router for multi-model support
  if [ "$ROUTER" = "true" ]; then
    if [ -z "$OPENAI_API_KEY" ] && [ -z "$OPENROUTER_API_KEY" ]; then
      echo "WARNING: No provider API key set (OPENAI_API_KEY or OPENROUTER_API_KEY). Router may not work."
    fi

    export ANTHROPIC_BASE_URL="${ANTHROPIC_BASE_URL:-http://localhost:3456}"
    export ANTHROPIC_AUTH_TOKEN="${ANTHROPIC_AUTH_TOKEN:-shannon-router-key}"
    echo "Router mode enabled. Ensure claude-code-router is running at ${ANTHROPIC_BASE_URL}."
    if command -v curl >/dev/null 2>&1; then
      local router_health_url="${ANTHROPIC_BASE_URL%/}/health"
      if ! curl -fsS "$router_health_url" >/dev/null 2>&1; then
        echo "WARNING: claude-code-router is not responding at ${router_health_url}."
      fi
    fi
  fi

  export TEMPORAL_ADDRESS="${TEMPORAL_ADDRESS:-localhost:7233}"

  ensure_build

  if [ -z "$OUTPUT" ]; then
    mkdir -p ./audit-logs
  fi

  # Ensure Temporal server and worker are running (starts them if needed)
  ensure_temporal
  ensure_worker

  # Build optional args
  ARGS=""
  [ -n "$CONFIG" ] && ARGS="$ARGS --config $CONFIG"

  if [ -n "$OUTPUT" ]; then
    ARGS="$ARGS --output $OUTPUT"
  fi

  [ "$PIPELINE_TESTING" = "true" ] && ARGS="$ARGS --pipeline-testing"

  # Run the client to submit workflow
  node dist/temporal/client.js "$URL" "$REPO" $ARGS
}

cmd_logs() {
  parse_args "$@"

  if [ -z "$ID" ]; then
    echo "ERROR: ID is required"
    echo "Usage: ./shannon logs ID=<workflow-id>"
    exit 1
  fi

  # Auto-discover the workflow log file
  # 1. Check default location first
  # 2. Search common output directories
  # 3. Fall back to find command
  WORKFLOW_LOG=""

  if [ -f "./audit-logs/${ID}/workflow.log" ]; then
    WORKFLOW_LOG="./audit-logs/${ID}/workflow.log"
  else
    # Search for the workflow directory (handles custom OUTPUT paths)
    FOUND=$(find . -maxdepth 3 -path "*/${ID}/workflow.log" -type f 2>/dev/null | head -1)
    if [ -n "$FOUND" ]; then
      WORKFLOW_LOG="$FOUND"
    fi
  fi

  if [ -n "$WORKFLOW_LOG" ]; then
    echo "Tailing workflow log: $WORKFLOW_LOG"
    tail -f "$WORKFLOW_LOG"
  else
    echo "ERROR: Workflow log not found for ID: $ID"
    echo ""
    echo "Possible causes:"
    echo "  - Workflow hasn't started yet"
    echo "  - Workflow ID is incorrect"
    echo ""
    echo "Check: ./shannon query ID=$ID for workflow details"
    exit 1
  fi
}

cmd_query() {
  parse_args "$@"

  if [ -z "$ID" ]; then
    echo "ERROR: ID is required"
    echo "Usage: ./shannon query ID=<workflow-id>"
    exit 1
  fi

  export TEMPORAL_ADDRESS="${TEMPORAL_ADDRESS:-localhost:7233}"
  ensure_build
  node dist/temporal/query.js "$ID"
}

cmd_stop() {
  parse_args "$@"

  stop_process "$WORKER_PID_FILE" "worker"
  stop_process "$TEMPORAL_PID_FILE" "Temporal server"

  if [ "$CLEAN" = "true" ]; then
    rm -rf "$RUNTIME_DIR"
  fi
}

# Main command dispatch
case "${1:-help}" in
  start)
    shift
    cmd_start "$@"
    ;;
  logs)
    shift
    cmd_logs "$@"
    ;;
  query)
    shift
    cmd_query "$@"
    ;;
  stop)
    shift
    cmd_stop "$@"
    ;;
  help|--help|-h|*)
    show_help
    ;;
esac
